# Calendar_Spread_Strategy

<<<<<<< Current (Your changes)
回测的整体思路和框架：

### 回测框架三大核心：数据、策略、执行

整个回测可以分为三个主要模块：**数据准备模块**、**策略逻辑模块** 和 **回测执行与分析模块**。

---

#### 模块一：数据准备与预处理 (Data Preparation)

这是所有回测的基础。我们需要一个干净、规整、包含所有必需信息的数据源。

1.  **加载数据**
2.  **数据清洗**:
    *   将日期列（如 `交易日期`、`到期日`）转换为标准的日期时间格式。
    *   确保价格（开盘、收盘、执行价等）是数值类型。
    *   处理可能存在的缺失值或异常值。
3.  **特征工程**:
    *   **计算每日剩余到期天数 (DTE - Days to Expiration)**：这是核心参数 `N` 的基础。对于每一行期权数据，计算 `DTE = 到期日 - 交易日期`。
    *   **关联标的价格**: 您的期权数据中可能没有包含每日的标的物（PTA主连期货）价格。您需要将 `PTA888.csv` (或其他标的价格文件) 的每日开盘价和收盘价，按照交易日期合并到主数据表中。这是计算虚值程度 `k` 的基础。

最终，您会得到一个包含每一天、每一个期权合约的详细信息（价格、到期日、执行价、DTE、当日标的价格等）的“大宽表”。

注意，执行价并没有单独成列，而是反映在了品种代码的C或P的后几位数字上，例如TA003C5600的行权价即5600.

---

#### 模块二：策略逻辑模块 (Strategy Logic)

这个模块是策略的“大脑”，负责在特定时间点决定是否交易、以及交易什么。

1.  **参数循环**: 整个回测需要在一个大的循环中运行，遍历所有参数组合。
    *   外层循环 `k` in `[0, 0.01, 0.02, 0.03, 0.04, 0.05, 0.06, 0.08]`
    *   内层循环 `N` in `range(5, 21)`

2.  **交易信号生成函数 (`find_trade_signal`)**: 这个函数是核心中的核心。它的输入是 `(某一天的数据, 当前持仓, k, N)`，输出是 `(需要开仓的合约列表, 需要平仓的合约列表)`。
    *   **平仓信号**: 检查当前持仓中，是否有**近月合约（空头仓位）已经到期**（即到期日剩余0的）。根据您的规则“持有至期权到期”，平仓信号非常简单：如果今天是近月合约的到期日，就发出平仓信号。注意这个近月合约是相对的，不是绝对的。例如上个月执行的买入远月的操作，虽然在买入时标记的是远月，但到快到期时就成了近月就要平仓了。总之平仓的逻辑就是检查当前持仓是否有任意合约即将到期，只平到期的，其他的不管。
    *   **开仓信号**: 在平仓后的下一个交易日触发。
        1.  **确定近月和次月**:
            *   获取当日的标的物开盘价 `Underlying_Open_Price`即表中的 '标的开盘价' 。
            *   筛选出当日所有可交易的期权。
            *   **近月合约筛选**: 找出所有 `DTE >= N` 的期权，并选择其中DTE最小的那个到期月份作为“近月”。注意此处应该有优化空间，即 >= N 应该会找出很多合约，所以考虑是 = N 的情况应该也可以的。但在执行的时候可能因为非交易日而无法执行，所以要将这种情况纳入考虑。
            *   **次月/季月合约筛选**: 选择比“近月”更晚到期的合约月份，作为“远月”。此处可以参考品种代码来筛选而不是到期日，例如近月选到了TA003C5600，则远月为TA004C5600.
        2.  **确定执行价格 (Strike Price)**:
            *   根据虚值程度 `k` 计算目标执行价。
                *   看涨期权目标执行价: `Strike_Call = Underlying_Open_Price * (1 + k)`
                *   看跌期权目标执行价: `Strike_Put = Underlying_Open_Price * (1 - k)`
            *   在筛选出的“近月”期权中，找到**实际执行价最接近** `Strike_Call` 和 `Strike_Put` 的两个合约（一个看涨，一个看跌）。这便是我们要卖出的合约。此处找合约的执行价格可以参考品种代码的字母 C or P 的后几位数字。例如品种TA003C4600的执行价就是4600.
        3.  **构建价差组合**:
            *   **卖出近月**: 记录下要卖出的近月看涨和看跌期权。
            *   **买入远月**: 找到与上述两个合约**执行价完全相同**的远月看涨和看跌期权，记录下来买入。
    *  请注意代码的robust，考虑没有需要开仓或需要平仓的情况。

---

#### 模块三：回测执行与分析模块 (Backtest Execution & Analysis)

这个模块是“裁判员”和“记账员”，它模拟真实的交易环境，并记录最终结果。

1.  **主循环 (Event Loop)**:
    *   按交易日从 `2020-01-01` 到 `2024-xx-xx` 逐日循环。
    *   初始化账户信息：`总资金`，`可用资金`，`持仓列表`，`每日净值记录`。

2.  **每日业务逻辑**: 在每一天的循环中：
    *   **更新持仓市值**: 用当日的收盘价更新现有持仓的价值，并计算当日组合总净值。
    *   **检查交易信号**: 调用 `find_trade_signal()` 函数。
    *   **执行平仓**: 如果有平仓信号，则按**收盘价**计算卖出期权的盈亏，资金回笼（别忘了扣除买入合约平仓的0.5元手续费），并清空持仓。注意，平仓也不是胡乱平，要对应之前开的哪个合约，现在平的哪个合约。而且只平需要平的合约（即到期日剩余0的），不需要平的就留着。
    *   **执行开仓**: 如果有开仓信号：
        1.  **计算保证金**: 卖出期权需要保证金。真实的保证金计算非常复杂（如CME的SPAN算法）。在回测初期，您可以采用交易所提供的简化公式，或者一个固定比例作为近似。例如：`保证金 = (合约结算价 + Max(标的价 * 保证金比例 - 虚值额, 最低保障系数)) * 数量`。此处请你酌情自行处理，考虑代码和现实的情况综合考虑，可以自行进行修改来计算。
        2.  **计算所需资金**: `总资金需求 = 卖出期权所需保证金 + 买入期权的总权利金`。
        3.  **资金分配**: 根据“动用资金比例为80%”的规则，计算本次可用于交易的资金。`可动用资金 = 账户总净值 * 80%`。
        4.  **计算手数**: `交易手数 = 可动用资金 / 每组价差策略的总资金需求`。此处由于开仓的当天可能会有四个方向需要做，考虑四个方向都平分。
        5.  **记录交易**: 在账户中记录下新持仓的详细信息（合约代码、方向、手数、开仓价等），并从可用资金中扣除所需资金和买入开仓的0.5元手续费。

3.  **结果分析**:
    *   当回测循环结束后，您会得到一条每日账户净值的时间序列。
    *   基于这个净值序列，计算各项性能指标：
        *   **累计收益率**
        *   **年化收益率**
        *   **夏普比率 (Sharpe Ratio)**
        *   **最大回撤 (Max Drawdown)**
        *   **胜率**
    *   将每个 `(k, N)` 参数组合的回测结果进行存储，最终通过多个个表格或热力图来展示不同参数下的策略表现，从而找到最优参数组合。请注意绘图的时候考虑中文无法正常显示的情况。
=======
期权跨期价差（Calendar Spread）策略回测实现：近月卖出、远月买入，同步选择行权价，参数网格遍历虚值程度 k 与目标 DTE 值 N，输出每日净值、交易明细与性能热力图。

## 数据输入
- 目标输入文件：`data/RB/master_option_data_RB.csv`
- 可通过 `ETL/CSS/prepare_data.py` 将多源数据合并成“大宽表”。关键字段：
  - `交易日期`（index）
  - `到期日`
  - `合约名称`（例如 RBxxxxCyyyy / RBxxxxPyyyy）
  - `剩余到期日`（DTE）
  - `标的开盘价`、`标的收盘价`
  - `今结算`（用于回测核心价格）

提示：在 Linux 环境下，将脚本中的反斜杠路径改为正斜杠，或在脚本内改为 `os.path.join`。

## 快速开始
- 全参数回测（`backtest.py`）：
```bash
python Calendar_Spread_Strategy/backtest.py
```
- 限定仅交易指定近月月份（`backtest_with_contract_month_filter.py`）：
```bash
python Calendar_Spread_Strategy/backtest_with_contract_month_filter.py
```

## 主要参数（在脚本顶部修改）
- `K_VALUES`: 虚值程度 k 列表，例如 `[0, 0.01, 0.02, 0.03, 0.04, 0.05, 0.06, 0.08]`
- `N_RANGE`: 近月目标 DTE 值范围，例如 `range(5, 21)`
- `DTE_TOLERANCE`: 实际 DTE 与目标 N 的容忍差
- `INITIAL_CAPITAL`: 初始资金
- `CAPITAL_USAGE_RATIO`: 单组交易可动用资金比例
- `COMMISSION_PER_CONTRACT`: 每手单边手续费
- `MARGIN_RATE_FUTURES`、`MIN_MARGIN_FACTOR`: 简化保证金估算参数
- `N_JOBS`: 并行计算核数
- `DATA_PATH`: 输入数据路径（默认 `'data\RB\master_option_data_RB.csv'`，跨平台请改正斜杠）
- `RESULTS_DIR`: 输出目录

在 `backtest_with_contract_month_filter.py` 中额外提供：
- `TRADE_CONTRACT_MONTHS`: 仅交易这些近月月份（如 `[1, 5, 10]`）

## 回测逻辑摘要
- 依据到期日序列，生成开平仓计划：开仓在到期日前 N 天附近，平仓在近月到期日收盘。
- 开仓日：
  - 按当日标的开盘价计算目标行权价：
    - 看涨目标行权价: `Strike_Call = underlying_open * (1 + k)`
    - 看跌目标行权价: `Strike_Put = underlying_open * (1 - k)`
  - 在近月中选择行权价最接近目标的看涨、看跌合约进行卖出；在更远月中买入相同行权价的看涨、看跌合约。
- 资金/保证金：
  - 卖出近月所需保证金按简化规则估算；买入远月按权利金支付；综合动用资金按 `CAPITAL_USAGE_RATIO` 限制进行手数计算。
- 平仓日：对本组合约以结算价进行平仓结算，记录盈亏与费用。

## 输出
- 脚本 `backtest.py` 的默认输出目录：`backtest_results/RB`
  - 每组参数 `(k, N)`：
    - `daily_equity_log_k{k}_N{N}.csv`
    - `trade_log_k{k}_N{N}.csv`
  - 汇总：`all_results.csv`
  - 可视化：`cagr_heatmap.png`、`sharpe_heatmap.png`、`max_drawdown_heatmap.png`、`win_rate_heatmap.png`
- 脚本 `backtest_with_contract_month_filter.py` 的默认输出目录：`backtest_results_159/RB`

## 依赖
```bash
pip install -U pandas numpy matplotlib seaborn joblib tqdm
```

## 备注
- 若数据中结算价为 0，代码会在开仓时将其替换为 0.5 以避免无法成交的异常情况。
- 若部分交易日缺少当日标的或个别合约报价，代码会使用可得的信息进行稳健回退处理。
>>>>>>> Incoming (Background Agent changes)
